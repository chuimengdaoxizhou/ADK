# ADK ä¸­çš„æŒä¹…åŒ–å­˜å‚¨

æœ¬ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•ä¸ºä½ çš„ ADK æ™ºèƒ½ä½“å®ç°æŒä¹…åŒ–å­˜å‚¨ï¼Œä½¿å…¶èƒ½å¤Ÿè®°ä½ä¿¡æ¯ï¼Œå¹¶åœ¨å¤šæ¬¡ä¼šè¯ã€åº”ç”¨ç¨‹åºé‡å¯ç”šè‡³æœåŠ¡å™¨é‡æ–°éƒ¨ç½²åä»èƒ½ä¿æŒå¯¹è¯å†å²ã€‚

---

## ä»€ä¹ˆæ˜¯ ADK ä¸­çš„æŒä¹…åŒ–å­˜å‚¨ï¼Ÿ

åœ¨ä¹‹å‰çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† `InMemorySessionService`ï¼Œå®ƒåªå°†ä¼šè¯æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­â€”â€”ä¸€æ—¦åº”ç”¨ç¨‹åºåœæ­¢è¿è¡Œï¼Œæ•°æ®å°±ä¼šä¸¢å¤±ã€‚è€Œåœ¨çœŸå®çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œé€šå¸¸éœ€è¦æ™ºèƒ½ä½“é•¿æœŸè®°ä½ç”¨æˆ·ä¿¡æ¯å’Œå¯¹è¯å†å²ã€‚è¿™æ—¶å°±éœ€è¦ **æŒä¹…åŒ–å­˜å‚¨**ã€‚

ADK æä¾›äº† `DatabaseSessionService`ï¼Œå¯ä»¥å°†ä¼šè¯æ•°æ®ä¿å­˜åœ¨ SQL æ•°æ®åº“ä¸­ï¼Œä»è€Œå®ç°ï¼š

1. **é•¿æœŸè®°å¿†**ï¼šæ•°æ®åœ¨ç¨‹åºé‡å¯åä»ç„¶å­˜åœ¨
2. **ä¸€è‡´çš„ç”¨æˆ·ä½“éªŒ**ï¼šç”¨æˆ·å¯ä»¥ä»ä¸Šæ¬¡ä¸­æ–­çš„åœ°æ–¹ç»§ç»­å¯¹è¯
3. **å¤šç”¨æˆ·æ”¯æŒ**ï¼šä¸åŒç”¨æˆ·çš„æ•°æ®æ˜¯éš”ç¦»å¹¶å®‰å…¨çš„
4. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒç”¨äºå¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒçš„æ•°æ®åº“ç³»ç»Ÿ

æœ¬ç¤ºä¾‹é€šè¿‡ä½¿ç”¨ SQLite æ•°æ®åº“ï¼Œå±•ç¤ºäº†å¦‚ä½•å®ç°ä¸€ä¸ªèƒ½è®°ä½ç”¨æˆ·å§“åå’Œå¾…åŠäº‹é¡¹çš„æé†’åŠ©æ‰‹ï¼ˆreminder agentï¼‰ã€‚

---

## é¡¹ç›®ç»“æ„

```
5-persistent-storage/
â”‚
â”œâ”€â”€ memory_agent/               # æ™ºèƒ½ä½“åŒ…
â”‚   â”œâ”€â”€ __init__.py             # ç”¨äº ADK å‘ç° agent çš„æ ‡å¿—æ–‡ä»¶
â”‚   â””â”€â”€ agent.py                # å®šä¹‰åŒ…å«æé†’å·¥å…·çš„æ™ºèƒ½ä½“
â”‚
â”œâ”€â”€ main.py                     # åº”ç”¨ä¸»å…¥å£ï¼Œè´Ÿè´£è®¾ç½®æ•°æ®åº“ä¼šè¯æœåŠ¡
â”œâ”€â”€ utils.py                    # è¾…åŠ©å·¥å…·å‡½æ•°ï¼Œæ”¯æŒç»ˆç«¯ UI å’Œæ™ºèƒ½ä½“äº¤äº’
â”œâ”€â”€ .env                        # ç¯å¢ƒå˜é‡æ–‡ä»¶
â”œâ”€â”€ my_agent_data.db            # SQLite æ•°æ®åº“æ–‡ä»¶ï¼ˆé¦–æ¬¡è¿è¡Œæ—¶åˆ›å»ºï¼‰
â””â”€â”€ README.md                   # æœ¬æ–‡æ¡£
```

---

## æ ¸å¿ƒç»„ä»¶

### 1. `DatabaseSessionService`

å®ç°æŒä¹…åŒ–çš„æ ¸å¿ƒæ˜¯ `DatabaseSessionService`ï¼Œå®ƒé€šè¿‡æ•°æ®åº“ URL åˆå§‹åŒ–ï¼š

```python
from google.adk.sessions import DatabaseSessionService

db_url = "sqlite:///./my_agent_data.db"
session_service = DatabaseSessionService(db_url=db_url)
```

è¯¥æœåŠ¡å¯ä»¥ï¼š

* å°†ä¼šè¯æ•°æ®å­˜å…¥ SQLite æ•°æ®åº“æ–‡ä»¶
* ä¸ºç”¨æˆ·æ£€ç´¢å…ˆå‰çš„ä¼šè¯
* è‡ªåŠ¨ç®¡ç†æ•°æ®åº“è¡¨ç»“æ„å’Œ schema

---

### 2. ä¼šè¯ç®¡ç†

ç¤ºä¾‹ä¸­å±•ç¤ºäº†å¦‚ä½•ç®¡ç†ä¼šè¯ï¼š

```python
# æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å·²æœ‰ä¼šè¯
existing_sessions = session_service.list_sessions(
    app_name=APP_NAME,
    user_id=USER_ID,
)

# å¦‚æœå·²æœ‰ä¼šè¯ï¼Œåˆ™ç»§ç»­ä½¿ç”¨ï¼›å¦åˆ™åˆ›å»ºæ–°çš„ä¼šè¯
if existing_sessions and len(existing_sessions.sessions) > 0:
    SESSION_ID = existing_sessions.sessions[0].id
    print(f"ç»§ç»­ä½¿ç”¨å·²æœ‰ä¼šè¯: {SESSION_ID}")
else:
    session_service.create_session(
        app_name=APP_NAME,
        user_id=USER_ID,
        session_id=SESSION_ID,
        state=initialize_state(),
    )
```

---

### 3. ä½¿ç”¨å·¥å…·ç®¡ç†çŠ¶æ€ï¼ˆstateï¼‰

æ™ºèƒ½ä½“ä¸­å®šä¹‰çš„å·¥å…·ä¼šè‡ªåŠ¨æ›´æ–°æŒä¹…åŒ–çŠ¶æ€ï¼š

```python
def add_reminder(reminder: str, tool_context: ToolContext) -> dict:
    # è·å–å½“å‰æé†’åˆ—è¡¨
    reminders = tool_context.state.get("reminders", [])
    
    # æ·»åŠ æ–°æé†’
    reminders.append(reminder)
    
    # æ›´æ–°çŠ¶æ€
    tool_context.state["reminders"] = reminders
    
    return {
        "action": "add_reminder",
        "reminder": reminder,
        "message": f"å·²æ·»åŠ æé†’: {reminder}",
    }
```

æ‰€æœ‰å¯¹ `tool_context.state` çš„ä¿®æ”¹ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚

---

## å¿«é€Ÿå¼€å§‹

### å…ˆå†³æ¡ä»¶

* Python 3.9+
* ç”¨äº Gemini æ¨¡å‹çš„ Google API Key
* SQLiteï¼ˆPython å·²å†…ç½®ï¼‰

---

### é¡¹ç›®è®¾ç½®

1. æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼š

```bash
# macOS/Linux:
source ../.venv/bin/activate
# Windows CMD:
..\.venv\Scripts\activate.bat
# Windows PowerShell:
..\.venv\Scripts\Activate.ps1
```

2. åœ¨ `.env` æ–‡ä»¶ä¸­è®¾ç½®ä½ çš„ Google API å¯†é’¥ï¼š

```
GOOGLE_API_KEY=your_api_key_here
```

---

### è¿è¡Œç¤ºä¾‹

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡ŒæŒä¹…åŒ–å­˜å‚¨ç¤ºä¾‹ï¼š

```bash
python main.py
```

æ­¤å‘½ä»¤å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. è¿æ¥æˆ–åˆ›å»º SQLite æ•°æ®åº“
2. æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å·²æœ‰ä¼šè¯
3. å¯åŠ¨æ™ºèƒ½ä½“å¯¹è¯
4. å°†æ‰€æœ‰å¯¹è¯è®°å½•ä¿å­˜è‡³æ•°æ®åº“

---

## ç¤ºä¾‹äº¤äº’

ä½ å¯ä»¥å°è¯•ä»¥ä¸‹å¯¹è¯æ¥æµ‹è¯•è®°å¿†åŠŸèƒ½ï¼š

### ç¬¬ä¸€æ¬¡è¿è¡Œï¼š

* â€œæˆ‘çš„åå­—æ˜¯ä»€ä¹ˆï¼Ÿâ€
* â€œæˆ‘å« Johnâ€
* â€œæ·»åŠ ä¸€ä¸ªæé†’ï¼šä¹°èœâ€
* â€œå†æ·»åŠ ä¸€ä¸ªæé†’ï¼šå®ŒæˆæŠ¥å‘Šâ€
* â€œæˆ‘æœ‰å“ªäº›æé†’ï¼Ÿâ€
* è¾“å…¥ "exit" é€€å‡ºç¨‹åº

### ç¬¬äºŒæ¬¡è¿è¡Œï¼š

* â€œæˆ‘çš„åå­—æ˜¯ä»€ä¹ˆï¼Ÿâ€
* â€œæˆ‘æœ‰å“ªäº›æé†’ï¼Ÿâ€
* â€œæŠŠç¬¬äºŒä¸ªæé†’æ›´æ–°ä¸ºï¼šå‘¨äº”å‰æäº¤æŠ¥å‘Šâ€
* â€œåˆ é™¤ç¬¬ä¸€ä¸ªæé†’â€

æ— è®ºé€€å‡ºç¨‹åºè¿˜æ˜¯é‡å¯ç³»ç»Ÿï¼Œæ™ºèƒ½ä½“éƒ½èƒ½è®°ä½ä¹‹å‰çš„å¯¹è¯å†…å®¹ã€‚

---

## åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨æ•°æ®åº“å­˜å‚¨

è™½ç„¶æœ¬ç¤ºä¾‹ä½¿ç”¨ SQLite æ¥ç®€åŒ–æ“ä½œï¼Œ`DatabaseSessionService` å®é™…ä¸Šæ”¯æŒé€šè¿‡ SQLAlchemy ä½¿ç”¨å„ç§æ•°æ®åº“åç«¯ï¼Œä¾‹å¦‚ï¼š

* PostgreSQLï¼š`postgresql://user:password@localhost/dbname`
* MySQLï¼š`mysql://user:password@localhost/dbname`
* MS SQL Serverï¼š`mssql://user:password@localhost/dbname`

### åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨çš„å»ºè®®ï¼š

1. é€‰æ‹©é€‚åˆä½ è§„æ¨¡éœ€æ±‚çš„æ•°æ®åº“ç³»ç»Ÿ
2. é…ç½®æ•°æ®åº“è¿æ¥æ± æé«˜æ€§èƒ½
3. åŠ å¼ºæ•°æ®åº“å‡­æ®çš„å®‰å…¨æ€§
4. ä¸ºå…³é”®æ•°æ®åšå¥½å¤‡ä»½ç­–ç•¥

---

## å…¶ä»–èµ„æº

* ğŸ“„ [ADK ä¼šè¯æ–‡æ¡£](https://google.github.io/adk-docs/sessions/session/)
* ğŸ§© [SessionService å®ç°](https://google.github.io/adk-docs/sessions/session/#sessionservice-implementations)
* ğŸ”§ [ADK çŠ¶æ€ç®¡ç†](https://google.github.io/adk-docs/sessions/state/)
* ğŸ“˜ [SQLAlchemy æ–‡æ¡£](https://docs.sqlalchemy.org/)ï¼ˆé«˜çº§æ•°æ®åº“é…ç½®ï¼‰

---


